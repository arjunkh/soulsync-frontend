<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoulSync AI - Intelligent Matchmaking</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Icons components (simplified)
        const Send = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
        );

        const Heart = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
        );

        const Settings = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.82,11.69,4.82,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
            </svg>
        );

        const Zap = () => (
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <path d="M13 0L0 14h8l-1 10 13-14h-8z"/>
            </svg>
        );

        const SoulSyncApp = () => {
            const [messages, setMessages] = useState([]);
            const [currentInput, setCurrentInput] = useState('');
            const [userInsights, setUserInsights] = useState({});
            const [isTyping, setIsTyping] = useState(false);
            const [waitingForResponse, setWaitingForResponse] = useState(false);
            const [phoneNumber, setPhoneNumber] = useState('');
            const [userName, setUserName] = useState('');
            const [userGender, setUserGender] = useState('');
            const [currentUserId, setCurrentUserId] = useState('');
            const [showSetup, setShowSetup] = useState(true);
            const [currentMood, setCurrentMood] = useState('');
            const [currentInterests, setCurrentInterests] = useState([]);
            const [isVerifying, setIsVerifying] = useState(false);
            const [coupleCompassActive, setCoupleCompassActive] = useState(false);
            const [currentQuestionNumber, setCurrentQuestionNumber] = useState(0);
            const [currentQuestionId, setCurrentQuestionId] = useState('');
            const [showQuickReplies, setShowQuickReplies] = useState(false);
            const messagesEndRef = useRef(null);

            // Get backend URL from environment or use relative path
            const backendUrl = window.location.origin.includes('railway') 
                ? 'https://soulsync-backend-production.up.railway.app'
                : window.location.origin;

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const addMessage = (message, isAI = true, delay = 0) => {
                setTimeout(() => {
                    setMessages(prev => [...prev, { 
                        text: message, 
                        isAI, 
                        timestamp: Date.now(),
                        id: Math.random().toString(36).substr(2, 9)
                    }]);
                    setIsTyping(false);
                    if (isAI) {
                        setWaitingForResponse(true);
                    }
                }, delay);
            };

            const simulateTyping = (duration = 1500) => {
                setIsTyping(true);
                setWaitingForResponse(false);
            };

            const getAIResponse = async (userMessage) => {
                try {
                    const conversationMessages = [
                        { role: "system", content: "You are Aria, an emotionally intelligent AI companion." },
                        ...messages.slice(-10).map(msg => ({
                            role: msg.isAI ? "assistant" : "user",
                            content: msg.text
                        })),
                        { role: "user", content: userMessage }
                    ];

                    const response = await fetch(`${backendUrl}/api/chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            messages: conversationMessages,
                            userId: currentUserId || 'user-default',
                            coupleCompassState: coupleCompassActive ? {
                                active: true,
                                questionIndex: currentQuestionNumber,
                                questionId: currentQuestionId
                            } : null
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        return `I'm having trouble connecting. Please try again. (${response.status})`;
                    }

                    const data = await response.json();
                    
                    // Update user insights
                    if (data.userInsights) {
                        setUserInsights(data.userInsights);
                        setCurrentMood(data.userInsights.detectedMood);
                        setCurrentInterests(data.userInsights.currentInterests);
                    }
                    // Update Couple Compass state from backend response
                    if (data.userInsights && data.userInsights.coupleCompassGameState) {
                      const gameState = data.userInsights.coupleCompassGameState;
                      
                      if (gameState.active) {
                        // Game is still active - update to next question
                        setCoupleCompassActive(true);
                        setCurrentQuestionNumber(gameState.questionIndex);
                        setCurrentQuestionId(gameState.questionId || '');
                        setShowQuickReplies(true);
                        console.log('🧭 Updated Couple Compass state:', {
                          questionIndex: gameState.questionIndex,
                          questionId: gameState.questionId
                        });
                      } else if (gameState.justCompleted) {
                        // Game just finished
                        setCoupleCompassActive(false);
                        setShowQuickReplies(false);
                        setCurrentQuestionNumber(0);
                        setCurrentQuestionId('');
                        console.log('🎉 Couple Compass completed!');
                      }
                    }


                    const responseText = data.choices[0].message.content;
                    if (responseText.includes('A)') && responseText.includes('B)') &&
                        responseText.includes('C)') && responseText.includes('D)')) {
                      setCoupleCompassActive(true);
                      setShowQuickReplies(true);
                      const match = responseText.match(/Question (\d+) of/);
                      if (match) setCurrentQuestionNumber(parseInt(match[1]));
                    } else if (responseText.includes('Couple Compass just gave me')) {
                      setCoupleCompassActive(false);
                      setShowQuickReplies(false);
                    }

                    return responseText;
                } catch (error) {
                    console.error('AI response error:', error);
                    return "I'm having trouble thinking right now. Can you try again?";
                }
            };

            const handleUserMessage = async (userMessage) => {
                addMessage(userMessage, false);
                setWaitingForResponse(false);
                setCurrentInput('');

                setTimeout(async () => {
                    simulateTyping(Math.random() * 1000 + 1500);
                    
                    const aiResponse = await getAIResponse(userMessage);
                    addMessage(aiResponse, true, 2500);
                }, 800);
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && currentInput.trim() && waitingForResponse) {
                    handleUserMessage(currentInput);
                }
            };

            const handleSendClick = () => {
                if (currentInput.trim() && waitingForResponse) {
                    handleUserMessage(currentInput);
                }
            };

            const startConversation = async () => {
                if (!userName.trim()) {
                    alert('Please enter your name first');
                    return;
                }
                
                if (!userGender) {
                    alert('Please select your gender');
                    return;
                }
                
                if (!phoneNumber.trim()) {
                    alert('Please enter your phone number');
                    return;
                }
                
                setIsVerifying(true);
                
                try {
                    // Verify phone number with backend
                    const response = await fetch(`${backendUrl}/api/verify-phone`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            phoneNumber: phoneNumber.trim(),
                            userName: userName.trim(),
                            userGender: userGender
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Phone verified successfully
                        setCurrentUserId(data.user.id);
                        setShowSetup(false);
                        setIsVerifying(false);
                        
                        // Start conversation with personalized greeting
                        setTimeout(() => {
                            simulateTyping();
                            if (data.user.isNewUser) {
                                addMessage(`Hey ${userName.trim()}! 😊`, true, 1500);
                                setTimeout(() => {
                                    addMessage("Before I ask anything... did you eat today?", true, 3000);
                                }, 2000);
                            } else {
                                addMessage(`Welcome back, ${userName.trim()}! 💕`, true, 1500);
                                setTimeout(() => {
                                    addMessage("How have you been since we last talked?", true, 3000);
                                }, 2000);
                            }
                        }, 1000);
                    } else {
                        // Phone verification failed
                        setIsVerifying(false);
                        if (data.waitlist) {
                            alert(`Thanks for your interest, ${userName.trim()}! SoulSync is currently in private beta. We'll notify you when it's available.`);
                        } else {
                            alert(data.message || 'Phone verification failed. Please try again.');
                        }
                    }
                } catch (error) {
                    setIsVerifying(false);
                    console.error('Phone verification error:', error);
                    alert('Connection error. Please check your internet and try again.');
                }
            };

            if (showSetup) {
                return React.createElement('div', 
                    { className: "max-w-md mx-auto bg-gradient-to-br from-rose-50 to-pink-50 min-h-screen flex flex-col justify-center p-6" },
                    React.createElement('div', 
                        { className: "bg-white rounded-2xl p-6 shadow-lg" },
                        React.createElement('div', 
                            { className: "text-center mb-6" },
                            React.createElement('div', 
                                { className: "w-16 h-16 bg-gradient-to-r from-rose-400 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-4" },
                                React.createElement(Heart, { className: "w-8 h-8 text-white" })
                            ),
                            React.createElement('h2', 
                                { className: "text-2xl font-bold text-gray-800 mb-2" },
                                "SoulSync AI"
                            ),
                            React.createElement('p', 
                                { className: "text-gray-600 text-sm" },
                                "Your intelligent matchmaking companion"
                            )
                        ),
                        React.createElement('div', 
                            { className: "space-y-4" },
                            React.createElement('div', 
                                { className: "bg-green-50 border border-green-200 rounded-lg p-3" },
                                React.createElement('div', 
                                    { className: "text-xs text-green-800" },
                                    React.createElement('p', 
                                        { className: "font-medium mb-1" },
                                        "✅ Complete Personal Profile!"
                                    ),
                                    React.createElement('p', null, "Aria will know your name, understand your context, and build authentic relationships tailored to you.")
                                )
                            ),
                            React.createElement('div', null,
                                React.createElement('label', 
                                    { className: "block text-sm font-medium text-gray-700 mb-2" },
                                    "👤 What should I call you?"
                                ),
                                React.createElement('input', {
                                    type: "text",
                                    value: userName,
                                    onChange: (e) => setUserName(e.target.value),
                                    placeholder: "Your name (e.g., Sarah, Alex, Morgan)",
                                    disabled: isVerifying,
                                    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-rose-400 text-sm disabled:bg-gray-50 mb-4"
                                })
                            ),
                            React.createElement('div', null,
                                React.createElement('label', 
                                    { className: "block text-sm font-medium text-gray-700 mb-2" },
                                    "⚧️ Gender"
                                ),
                                React.createElement('select', {
                                    value: userGender,
                                    onChange: (e) => setUserGender(e.target.value),
                                    disabled: isVerifying,
                                    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-rose-400 text-sm disabled:bg-gray-50 mb-4"
                                }, 
                                    React.createElement('option', { value: '' }, "Select your gender"),
                                    React.createElement('option', { value: 'Male' }, "👨 Male"),
                                    React.createElement('option', { value: 'Female' }, "👩 Female")
                                )
                            ),
                            React.createElement('div', null,
                                React.createElement('label', 
                                    { className: "block text-sm font-medium text-gray-700 mb-2" },
                                    "📱 Your Phone Number"
                                ),
                                React.createElement('input', {
                                    type: "tel",
                                    value: phoneNumber,
                                    onChange: (e) => setPhoneNumber(e.target.value),
                                    placeholder: "+91 98765 43210 or 9876543210",
                                    disabled: isVerifying,
                                    className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-rose-400 text-sm disabled:bg-gray-50"
                                }),
                                React.createElement('p', 
                                    { className: "text-xs text-gray-500 mt-1" },
                                    "We'll remember you across sessions"
                                )
                            ),
                            React.createElement('button', {
                                onClick: startConversation,
                                disabled: isVerifying,
                                className: `w-full bg-gradient-to-r from-rose-400 to-pink-500 text-white rounded-lg py-4 font-bold text-lg hover:shadow-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed`
                            }, isVerifying ? "🔄 Verifying..." : "💕 Meet Aria"),
                            React.createElement('div', 
                                { className: "bg-purple-50 p-4 rounded-lg text-xs" },
                                React.createElement('p', 
                                    { className: "font-bold text-purple-800 mb-2" },
                                    "🧠 Intelligent Features:"
                                ),
                                React.createElement('div', 
                                    { className: "grid grid-cols-2 gap-1 text-purple-700" },
                                    React.createElement('p', null, "• Complete profiling"),
                                    React.createElement('p', null, "• Cross-session memory"),
                                    React.createElement('p', null, "• Adaptive personality"),
                                    React.createElement('p', null, "• Mood detection"),
                                    React.createElement('p', null, "• Emotional intelligence"),
                                    React.createElement('p', null, "• Relationship building")
                                )
                            )
                        )
                    )
                );
            }

            const insightCount = Object.keys(userInsights).length;

            const QuickReplyButtons = () => {
                if (!showQuickReplies) return null;
                return React.createElement('div',
                    { className: "flex justify-center gap-2 p-2 bg-white/80" },
                    ...['A', 'B', 'C', 'D'].map(option =>
                        React.createElement('button', {
                            key: option,
                            onClick: () => {
                                handleUserMessage(option);
                                setShowQuickReplies(false);
                            },
                            className: "w-12 h-12 rounded-full border-2 border-rose-400 text-rose-600 font-bold hover:bg-rose-50"
                        }, option)
                    )
                );
            };

            return React.createElement('div', 
                { className: "max-w-md mx-auto bg-gradient-to-br from-rose-50 to-pink-50 min-h-screen flex flex-col" },
                // Header
                React.createElement('div', 
                    { className: "bg-white/80 backdrop-blur p-4 border-b border-rose-100" },
                    React.createElement('div', 
                        { className: "flex items-center justify-between" },
                        React.createElement('div', 
                            { className: "flex items-center space-x-3" },
                            React.createElement('div', 
                                { className: "w-8 h-8 bg-gradient-to-r from-rose-400 to-pink-500 rounded-full flex items-center justify-center" },
                                React.createElement(Heart, { className: "w-4 h-4 text-white" })
                            ),
                            React.createElement('div', null,
                                React.createElement('div', 
                                    { className: "font-medium text-gray-800" },
                                    "Aria"
                                ),
                                React.createElement('div', 
                                    { className: "text-xs text-gray-500" },
                                    "remembers you • intelligent mode"
                                )
                            )
                        ),
                        React.createElement('div', 
                            { className: "flex items-center space-x-2" },
                            React.createElement('div', 
                                { className: "text-xs text-gray-400" },
                                `${insightCount} insights`
                            ),
                            React.createElement('button', {
                                onClick: () => setShowSetup(true),
                                className: "text-gray-400 hover:text-gray-600"
                            }, React.createElement(Settings, { className: "w-4 h-4" }))
                        )
                    )
                ),
                coupleCompassActive && React.createElement('div',
                    { className: "bg-gradient-to-r from-rose-400 to-pink-500 text-white p-2" },
                    React.createElement('div', { className: "text-center text-sm" },
                        `🧭 Couple Compass • Question ${currentQuestionNumber + 1} of 6`
                    ),
                    React.createElement('div', { className: "w-full bg-white/30 h-1 rounded mt-1" },
                        React.createElement('div', {
                            className: "bg-white h-full rounded transition-all",
                            style: { width: `${(currentQuestionNumber / 6) * 100}%` }
                        })
                    )
                ),
                // Intelligence Status
                (currentMood || currentInterests.length > 0) && React.createElement('div', 
                    { className: "bg-gradient-to-r from-purple-50 to-blue-50 border-b border-purple-100 p-3" },
                    React.createElement('div', 
                        { className: "flex items-center space-x-2 text-xs" },
                        React.createElement(Zap, { className: "w-3 h-3 text-purple-500" }),
                        React.createElement('span', 
                            { className: "text-purple-700" },
                            `${currentMood ? `Mood: ${currentMood.replace('_', ' ')}` : ''}${currentMood && currentInterests.length > 0 ? ' • ' : ''}${currentInterests.length > 0 ? `Interests: ${currentInterests.join(', ').replace(/_/g, ' ')}` : ''}`
                        )
                    )
                ),
                // Messages
                React.createElement('div', 
                    { className: "flex-1 overflow-y-auto p-4 space-y-3" },
                    ...messages.map((message) => 
                        React.createElement('div', 
                            { key: message.id, className: `flex ${message.isAI ? 'justify-start' : 'justify-end'}` },
                            React.createElement('div', 
                                { className: `max-w-xs rounded-2xl px-4 py-3 ${message.isAI ? 'bg-white text-gray-800 shadow-sm' : 'bg-gradient-to-r from-rose-400 to-pink-500 text-white'}` },
                                React.createElement('div', 
                                    { className: "text-sm leading-relaxed" },
                                    message.text
                                ),
                                React.createElement('div', 
                                    { className: `text-xs mt-1 ${message.isAI ? 'text-gray-400' : 'text-rose-100'}` },
                                    new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                                )
                            )
                        )
                    ),
                    // Typing indicator
                    isTyping && React.createElement('div', 
                        { className: "flex justify-start" },
                        React.createElement('div', 
                            { className: "bg-white rounded-2xl px-4 py-3 shadow-sm" },
                            React.createElement('div', 
                                { className: "flex space-x-1" },
                                React.createElement('div', { className: "w-2 h-2 bg-gray-400 rounded-full animate-bounce" }),
                                React.createElement('div', { className: "w-2 h-2 bg-gray-400 rounded-full animate-bounce", style: {animationDelay: '0.1s'} }),
                                React.createElement('div', { className: "w-2 h-2 bg-gray-400 rounded-full animate-bounce", style: {animationDelay: '0.2s'} })
                            )
                        )
                    ),
                    React.createElement('div', { ref: messagesEndRef })
                ),
                React.createElement(QuickReplyButtons),
                // Input
                React.createElement('div',
                    { className: "p-4 bg-white/80 backdrop-blur border-t border-rose-100" },
                    React.createElement('div', 
                        { className: "flex space-x-2" },
                        React.createElement('input', {
                            type: "text",
                            value: currentInput,
                            onChange: (e) => setCurrentInput(e.target.value),
                            onKeyPress: handleKeyPress,
                            placeholder: waitingForResponse ? "Type your response..." : "Aria is thinking...",
                            disabled: !waitingForResponse,
                            className: `flex-1 rounded-full px-4 py-2 border text-sm transition-all ${waitingForResponse ? 'border-rose-200 focus:outline-none focus:border-rose-400' : 'border-gray-200 bg-gray-50 text-gray-400'}`
                        }),
                        React.createElement('button', {
                            onClick: handleSendClick,
                            disabled: !waitingForResponse || !currentInput.trim(),
                            className: `w-10 h-10 rounded-full flex items-center justify-center text-white transition-all duration-200 ${waitingForResponse && currentInput.trim() ? 'bg-gradient-to-r from-rose-400 to-pink-500 hover:shadow-lg' : 'bg-gray-300'}`
                        }, React.createElement(Send, { className: "w-4 h-4" }))
                    ),
                    // Insights
                    insightCount > 0 && React.createElement('div', 
                        { className: "mt-2 text-xs text-gray-500 text-center" },
                        `Learning: ${Object.keys(userInsights).join(', ').replace(/_/g, ' ')}`
                    )
                )
            );
        };

        ReactDOM.render(React.createElement(SoulSyncApp), document.getElementById('root'));
    </script>
</body>
</html>
